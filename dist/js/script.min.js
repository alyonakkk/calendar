let events=localStorage.getItem("events")?JSON.parse(localStorage.getItem("events")):[],clicked=null,date=new Date,todayMonth=date.getMonth(),todayYear=date.getFullYear(),nowMonth=null,nowYear=null;function putEventForDay(){document.querySelectorAll(".js-cell").forEach((e=>{let t=`${e.id}.${nowMonth+1}.${nowYear}`,n=events.find((e=>e.date===t));if(n){let t=e.querySelector(".js-cell-title"),l=e.querySelector(".js-cell-names"),o=e.querySelector(".js-cell-description");t.innerHTML=n.event,l.innerHTML=n.names,o.innerHTML=n.descripion,e.classList.add("td__td-event")}}))}function cellEventListener(){let e=0;document.querySelector(".js-table").addEventListener("click",(t=>{closeWindows();let n=t.target.closest("td");if(n&&n.id>0){clicked=n;let t=`${clicked.id}.${nowMonth+1}.${nowYear}`;0!==e&&(e.classList.remove("td__active"),e.classList.contains("td__td-event")&&e.classList.remove("td__td-event-click")),clicked.classList.contains("td__td-event")&&clicked.classList.add("td__td-event-click"),clicked.classList.add("td__active"),e=clicked,openCellPopup(t)}}))}function openCellPopup(e){let t=document.querySelector(".js-cell-popup-event"),n=document.querySelector(".js-cell-popup-date"),l=document.querySelector(".js-cell-popup-names"),o=document.querySelector(".js-cell-popup-description");t.value="",l.value="",o.value="",putEventToPopup(e,t,l,o);let c=document.querySelector(".js-cell-popup");c.style.display="flex";let s=clicked.getBoundingClientRect();c.style.left=s.left+s.width+14+"px",c.style.top=s.top+"px",document.querySelector(".js-cell-popup-date").value=e,closeCellButton(),createEvent(t,n,l,o),removeEvent(n)}function putEventToPopup(e,t,n,l){let o=events.find((t=>t.date===e));o&&(t.value=o.event,n.value=o.names,l.value=o.descripion)}function createEvent(e,t,n,l){document.querySelector(".js-cell-form").addEventListener("submit",(o=>{o.preventDefault(),0===e.value.length?e.classList.add("cell-popup__input-invalid"):(events=events.filter((e=>e.date!==t.value)),localStorage.setItem("events",JSON.stringify(events)),events.push({date:t.value,event:e.value,names:n.value,descripion:l.value}),localStorage.setItem("events",JSON.stringify(events)),clicked=null,closeWindows(),render(nowMonth,nowYear))}))}function removeEvent(e){document.querySelector(".js-cell-popup-remove").addEventListener("click",(()=>{events=events.filter((t=>t.date!==e.value)),localStorage.setItem("events",JSON.stringify(events)),clicked=null,closeWindows(),render(nowMonth,nowYear)}))}function closeCellButton(){document.querySelector(".js-cell-popup-close").addEventListener("click",(()=>{closeWindows(),clicked=null}))}function render(e,t){let n=1,l=new Date(t,e+1,0).getDate(),o=new Date(t,e).getDay(),c=["Понедельник","Вторник","Среда","Четверг","Пятница","Суббота","Воскресенье"];nowMonth=e,nowYear=t,document.querySelector(".js-nav-date").innerHTML=`${["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"][e]} ${t}`;let s=document.querySelector(".js-tbody");s.innerHTML="";for(let e=1;e<7;e+=1){let t=document.createElement("tr");t.classList.add("table__tr");for(let s=1;s<=7&&n<=l;s+=1){let l=document.querySelector("#cell"),r=l.content.querySelector(".js-cell"),d=l.content.querySelector(".js-cell-date");1===e?s>=o?(d.innerHTML=`${c[s-1]}, ${n}`,r.id=n,n+=1):(d.innerHTML=`${c[s-1]}`,r.id=0):(d.innerHTML=n,r.id=n,n+=1);let i=l.content.cloneNode(!0);t.appendChild(i)}s.appendChild(t)}putEventForDay(),cellEventListener()}let monthLow=["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"];function quickCreateEvent(){document.querySelector(".js-quick-create").addEventListener("click",(()=>{let e=document.querySelector(".js-popup-input"),t=e.value.split(", "),n=t[0],l=n.split(" ")[0],o=n.split(" ")[1],c=t[1],s=t[2],r=`${l}.${monthLow.indexOf(o)+1}.${nowYear}`;if(3!==t.length||l>31||l<0||-1===monthLow.indexOf(o))e.classList.add("popup__invalid-input");else{e.classList.remove("popup__invalid-input"),events.find((e=>e.date===r))?alert("На этот день уже назначено событие!"):(events.push({date:r,event:c,names:s,descripion:""}),localStorage.setItem("events",JSON.stringify(events)),render(monthLow.indexOf(o),nowYear)),clicked=null,closeWindows()}}))}function closeQuickButton(){document.querySelector(".js-close-quick-popup").addEventListener("click",(()=>{clicked=null,closeWindows()}))}function renderSearchList(){let e=document.querySelector(".js-search-list");e.innerHTML="",events.forEach((t=>{let n=document.querySelector("#search-item"),l=n.content.querySelector(".js-search-list-event"),o=n.content.querySelector(".js-search-list-date");l.innerHTML=t.event,o.innerHTML=`${t.date.split(".")[0]} ${monthLow[t.date.split(".")[1]-1]} ${t.date.split(".")[2]}`;let c=n.content.cloneNode(!0);e.appendChild(c)})),document.querySelectorAll(".js-search-item").forEach((e=>{e.addEventListener("click",(()=>{let t=e.querySelector(".js-search-list-date").textContent;closeWindows(),render(monthLow.indexOf(t.split(" ")[1]),t.split(" ")[2])}))}))}function closeWindows(){let e=document.querySelector(".js-quick-popup"),t=document.querySelector(".js-search-close"),n=document.querySelector(".js-search-list-wrap"),l=document.querySelector(".js-cell-popup"),o=document.querySelector(".js-search-input"),c=document.querySelector(".js-popup-input"),s=document.querySelector(".js-quick-add"),r=document.querySelector(".js-cell-popup-event");o.value="",c.value="",e.style.display="none",t.style.display="none",n.style.display="none",l.style.display="none",s.classList.remove("actions-header__btn-active"),c.classList.remove("popup__invalid-input"),r.classList.remove("cell-popup__input-invalid"),(clicked||"object"!=typeof clicked)&&(clicked.classList.remove("td__active"),clicked.classList.contains("td__td-event")&&clicked.classList.remove("td__td-event-click"))}!function(){let e=document.querySelector(".js-quick-add");e.addEventListener("click",(()=>{closeWindows(),document.querySelector(".js-quick-popup").style.display="block",e.classList.add("actions-header__btn-active"),quickCreateEvent(),closeQuickButton()}))}(),function(){let e=document.querySelector(".js-search-input");e.value="",e.addEventListener("focus",(()=>{closeWindows();let e=document.querySelector(".js-search-close"),t=document.querySelector(".js-search-list-wrap");e.style.display="block",t.style.display="block",e.addEventListener("click",(()=>{closeWindows()})),renderSearchList()})),e.addEventListener("keyup",(()=>{document.querySelectorAll(".js-search-item").forEach((t=>{-1===t.innerHTML.search(e.value)?t.style.display="none":t.style.display="block"}))}))}(),document.querySelector(".js-reload").addEventListener("click",(()=>{location.reload()})),document.querySelector(".js-nav-next").addEventListener("click",(()=>{nowMonth+1<12?nowMonth+=1:(nowMonth=0,nowYear+=1),closeWindows(),render(nowMonth,nowYear)})),document.querySelector(".js-nav-prev").addEventListener("click",(()=>{nowMonth-1>=0?nowMonth-=1:(nowMonth=11,nowYear-=1),closeWindows(),render(nowMonth,nowYear)})),document.querySelector(".js-nav-today").addEventListener("click",(()=>{closeWindows(),render(todayMonth,todayYear)})),closeWindows(),render(todayMonth,todayYear);